name: Build libXray for Android & Apple

on:
  # Ручной запуск из вкладки Actions
  workflow_dispatch:

  # Автоматический запуск при пуше тега, например: libxray-1.0.0
  push:
    branches: [ main ]
    tags:
      - "libxray-*"

jobs:
  android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: xray-core

      - name: Checkout libXray wrapper
        uses: actions/checkout@v4
        with:
          repository: XTLS/libXray
          path: libXray

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: xray-core/go.mod

      - name: Set up Java (for Android tools if needed)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Android NDK (r29, 16KB-ready)
        id: ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r29
          link-to-sdk: true

      - name: Use local Xray-core sources in libXray
        working-directory: libXray
        run: |
          go mod edit -replace github.com/xtls/xray-core=../xray-core
          go mod tidy

      - name: Install gomobile & gobind
        env:
          ANDROID_NDK_HOME: ${{ steps.ndk.outputs.ndk-path }}
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$HOME/go/bin" >> "$GITHUB_PATH"
          gomobile init

      - name: Build Android libXray (16KB page size)
        working-directory: libXray
        env:
          ANDROID_NDK_HOME: ${{ steps.ndk.outputs.ndk-path }}
          # заставляем линкер выровнять сегменты под 16KB
          CGO_LDFLAGS: "-O2 -s -w -Wl,-z,max-page-size=16384"
        run: |
          python3 build/main.py android

      - name: List Android build outputs (debug)
        run: |
          echo "==== libXray root ===="
          ls -la libXray || true
          echo "==== libXray build artifacts ===="
          ls -R libXray | sed 's/^/  /' || true

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libxray-android
          path: |
            libXray/libXray.aar
            libXray/libXray-sources.jar
            libXray/apple_xcframework/**
          if-no-files-found: warn

  apple:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: xray-core

      - name: Checkout libXray wrapper
        uses: actions/checkout@v4
        with:
          repository: XTLS/libXray
          path: libXray

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: xray-core/go.mod

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Use local Xray-core sources in libXray
        working-directory: libXray
        run: |
          go mod edit -replace github.com/xtls/xray-core=../xray-core
          go mod tidy

      - name: Install gomobile & gobind
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$HOME/go/bin" >> "$GITHUB_PATH"
          gomobile init

      - name: Build Apple (cgo) libXray
        working-directory: libXray
        run: |
          python3 build/main.py apple go

      - name: List Apple build outputs (debug)
        run: |
          echo "==== libXray root ===="
          ls -la libXray || true
          echo "==== libXray build artifacts ===="
          ls -R libXray | sed 's/^/  /' || true

      - name: Upload Apple artifacts
        uses: actions/upload-artifact@v4
        with:
          name: libxray-apple
          path: |
            libXray/LibXray.xcframework/**
            libXray/apple_xcframework/**
          if-no-files-found: warn
